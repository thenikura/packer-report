
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Linnworks Pack Report</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;margin:20px;max-width:1200px;}
  h3{margin-top:28px;margin-bottom:12px;}
  .panels{display:flex;gap:16px;flex-wrap:wrap;}
  .filters{border:1px solid #ccc;padding:12px;background:#fafafa;border-radius:6px;min-width:260px}
  table{border-collapse:collapse;width:100%;margin-bottom:20px;table-layout:fixed;}
  th,td{border:1px solid #ddd;padding:6px 8px;font-size:13px;text-align:center;}
  thead th{background:#f8f8f8;font-weight:600;}
  tbody tr:nth-child(even) td{background:#fafafa;}
  svg{display:block;margin:10px auto 30px auto;}
  label{display:inline-block;margin:4px 0;}
</style>
</head>
<body>

<h1>Linnworks Packing Report</h1>

<div class="panels">
  <div class="filters">
    <strong>Processed Date Range</strong><br/>
    <label>From: <input type="date" id="fromDate"></label><br/>
    <label>To: <input type="date" id="toDate"></label><br/>
    <button id="applyBtn">Apply</button>
    <div id="rangeInfo" style="margin-top:6px;color:#555;font-size:12px"></div>
  </div>

  <div class="filters">
    <strong>Show Packers</strong><br/>
    <label><input type="checkbox" class="user-toggle" data-user="packer7@nikura.com" checked/> packer7@nikura.com</label><br/><label><input type="checkbox" class="user-toggle" data-user="packer3@nikura.com" checked/> packer3@nikura.com</label><br/><label><input type="checkbox" class="user-toggle" data-user="packer8@nikura.com" checked/> packer8@nikura.com</label><br/><label><input type="checkbox" class="user-toggle" data-user="packer1@nikura.com" checked/> packer1@nikura.com</label><br/><label><input type="checkbox" class="user-toggle" data-user="packer6@nikura.com" checked/> packer6@nikura.com</label><br/>
  </div>
</div>

<h3>Dispatched per Hour (Compact)</h3>
<div id="table-wrapper"></div>

<h3>Dispatched per Hour (Chart)</h3>
<div id="chart-orders"></div>

<h3>Average Minutes per Order (Chart)</h3>
<div id="chart-avg"></div>

<h3>Total Dispatched</h3>
<div id="totals-table"></div>

<script>
// ---- Embedded data from Postman ----
const RAW_EVENTS = [{"user":"packer7@nikura.com","date":"2025-09-24T10:43:27.6Z"},{"user":"packer3@nikura.com","date":"2025-09-24T10:42:43.723Z"},{"user":"packer1@nikura.com","date":"2025-09-24T10:42:18.803Z"},{"user":"packer8@nikura.com","date":"2025-09-24T10:41:54.963Z"},{"user":"packer7@nikura.com","date":"2025-09-24T10:41:00.08Z"},{"user":"packer6@nikura.com","date":"2025-09-24T10:40:46.287Z"},{"user":"packer3@nikura.com","date":"2025-09-24T10:40:43.177Z"},{"user":"packer8@nikura.com","date":"2025-09-24T10:39:09.22Z"},{"user":"packer1@nikura.com","date":"2025-09-24T10:38:15.58Z"},{"user":"packer7@nikura.com","date":"2025-09-24T10:37:41.457Z"},{"user":"packer3@nikura.com","date":"2025-09-24T10:36:51.55Z"},{"user":"packer1@nikura.com","date":"2025-09-24T10:35:51.4Z"},{"user":"packer8@nikura.com","date":"2025-09-24T10:35:51.373Z"},{"user":"packer7@nikura.com","date":"2025-09-24T10:35:30.66Z"},{"user":"packer3@nikura.com","date":"2025-09-24T10:35:14.63Z"},{"user":"packer6@nikura.com","date":"2025-09-24T10:34:39.44Z"},{"user":"packer8@nikura.com","date":"2025-09-24T10:33:28.443Z"},{"user":"packer7@nikura.com","date":"2025-09-24T10:33:20.04Z"},{"user":"packer1@nikura.com","date":"2025-09-24T10:33:11.24Z"},{"user":"packer3@nikura.com","date":"2025-09-24T10:32:43.82Z"},{"user":"packer1@nikura.com","date":"2025-09-24T10:31:08.85Z"},{"user":"packer3@nikura.com","date":"2025-09-24T10:30:33.647Z"},{"user":"packer8@nikura.com","date":"2025-09-24T10:30:33.53Z"},{"user":"packer6@nikura.com","date":"2025-09-24T10:30:22.16Z"},{"user":"packer7@nikura.com","date":"2025-09-24T10:30:12.377Z"},{"user":"packer1@nikura.com","date":"2025-09-24T10:28:20.393Z"},{"user":"packer7@nikura.com","date":"2025-09-24T10:27:36.323Z"},{"user":"packer3@nikura.com","date":"2025-09-24T10:27:05.103Z"},{"user":"packer8@nikura.com","date":"2025-09-24T10:26:31.447Z"},{"user":"packer6@nikura.com","date":"2025-09-24T10:26:01.793Z"},{"user":"packer1@nikura.com","date":"2025-09-24T10:25:53.417Z"},{"user":"packer7@nikura.com","date":"2025-09-24T10:25:31.04Z"},{"user":"packer7@nikura.com","date":"2025-09-24T10:24:23.783Z"},{"user":"packer7@nikura.com","date":"2025-09-24T10:23:24.16Z"},{"user":"packer8@nikura.com","date":"2025-09-24T10:22:30.987Z"},{"user":"packer7@nikura.com","date":"2025-09-24T10:22:09.23Z"},{"user":"packer6@nikura.com","date":"2025-09-24T10:20:43.09Z"},{"user":"packer3@nikura.com","date":"2025-09-24T10:19:57.557Z"},{"user":"packer8@nikura.com","date":"2025-09-24T10:19:24.96Z"},{"user":"packer6@nikura.com","date":"2025-09-24T10:16:47.8Z"},{"user":"packer3@nikura.com","date":"2025-09-24T10:16:43.49Z"},{"user":"packer8@nikura.com","date":"2025-09-24T10:15:27.963Z"},{"user":"packer1@nikura.com","date":"2025-09-24T10:14:51.017Z"},{"user":"packer7@nikura.com","date":"2025-09-24T10:14:47.747Z"},{"user":"packer7@nikura.com","date":"2025-09-24T10:13:53.873Z"},{"user":"packer8@nikura.com","date":"2025-09-24T10:12:43.42Z"},{"user":"packer3@nikura.com","date":"2025-09-24T10:10:47.797Z"},{"user":"packer8@nikura.com","date":"2025-09-24T10:10:56.467Z"},{"user":"packer6@nikura.com","date":"2025-09-24T10:11:25.01Z"},{"user":"packer1@nikura.com","date":"2025-09-24T10:10:46.673Z"},{"user":"packer1@nikura.com","date":"2025-09-24T10:10:37.913Z"},{"user":"packer1@nikura.com","date":"2025-09-24T10:09:19.047Z"},{"user":"packer3@nikura.com","date":"2025-09-24T10:08:16.703Z"},{"user":"packer8@nikura.com","date":"2025-09-24T10:08:01.407Z"},{"user":"packer1@nikura.com","date":"2025-09-24T10:07:51.097Z"},{"user":"packer6@nikura.com","date":"2025-09-24T10:07:41.77Z"},{"user":"packer1@nikura.com","date":"2025-09-24T10:06:21.137Z"},{"user":"packer8@nikura.com","date":"2025-09-24T10:05:20.39Z"},{"user":"packer1@nikura.com","date":"2025-09-24T10:04:10.917Z"},{"user":"packer6@nikura.com","date":"2025-09-24T10:03:34.36Z"},{"user":"packer3@nikura.com","date":"2025-09-24T10:02:51.593Z"},{"user":"packer1@nikura.com","date":"2025-09-24T10:02:45.717Z"},{"user":"packer8@nikura.com","date":"2025-09-24T10:02:43.613Z"},{"user":"packer1@nikura.com","date":"2025-09-24T10:01:14.98Z"},{"user":"packer1@nikura.com","date":"2025-09-24T09:59:57.43Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:59:07.99Z"},{"user":"packer6@nikura.com","date":"2025-09-24T09:58:39.17Z"},{"user":"packer1@nikura.com","date":"2025-09-24T09:58:33.163Z"},{"user":"packer1@nikura.com","date":"2025-09-24T09:56:59.2Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:56:46.733Z"},{"user":"packer6@nikura.com","date":"2025-09-24T09:55:35.3Z"},{"user":"packer1@nikura.com","date":"2025-09-24T09:54:56.55Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:54:42.273Z"},{"user":"packer8@nikura.com","date":"2025-09-24T09:53:34.907Z"},{"user":"packer6@nikura.com","date":"2025-09-24T09:52:08.86Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:52:06.457Z"},{"user":"packer8@nikura.com","date":"2025-09-24T09:51:36.25Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:51:09.853Z"},{"user":"packer1@nikura.com","date":"2025-09-24T09:50:16.71Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:50:06.233Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:49:27.827Z"},{"user":"packer1@nikura.com","date":"2025-09-24T09:48:51.737Z"},{"user":"packer8@nikura.com","date":"2025-09-24T09:47:57.627Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:47:10.607Z"},{"user":"packer1@nikura.com","date":"2025-09-24T09:46:54.763Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:45:17.113Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:45:09.2Z"},{"user":"packer1@nikura.com","date":"2025-09-24T09:45:14.31Z"},{"user":"packer8@nikura.com","date":"2025-09-24T09:44:55.947Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:44:23.043Z"},{"user":"packer1@nikura.com","date":"2025-09-24T09:43:34.5Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:42:43.647Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:41:51.797Z"},{"user":"packer1@nikura.com","date":"2025-09-24T09:41:00.6Z"},{"user":"packer6@nikura.com","date":"2025-09-24T09:40:56.503Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:40:46.733Z"},{"user":"packer1@nikura.com","date":"2025-09-24T09:39:12.237Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:38:46.68Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:38:43.087Z"},{"user":"packer8@nikura.com","date":"2025-09-24T09:37:43.883Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:37:42.633Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:36:43.85Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:36:44.72Z"},{"user":"packer1@nikura.com","date":"2025-09-24T09:36:33.35Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:35:51.31Z"},{"user":"packer8@nikura.com","date":"2025-09-24T09:35:20.713Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:34:46.463Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:34:32.7Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:34:11.34Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:33:20.073Z"},{"user":"packer8@nikura.com","date":"2025-09-24T09:33:17.613Z"},{"user":"packer1@nikura.com","date":"2025-09-24T09:33:01.14Z"},{"user":"packer8@nikura.com","date":"2025-09-24T09:31:31.707Z"},{"user":"packer6@nikura.com","date":"2025-09-24T09:31:16.783Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:30:17.29Z"},{"user":"packer8@nikura.com","date":"2025-09-24T09:29:22.71Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:29:00.97Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:27:46.68Z"},{"user":"packer8@nikura.com","date":"2025-09-24T09:26:44.563Z"},{"user":"packer1@nikura.com","date":"2025-09-24T09:26:43.417Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:24:47.06Z"},{"user":"packer8@nikura.com","date":"2025-09-24T09:24:16.693Z"},{"user":"packer1@nikura.com","date":"2025-09-24T09:23:28.053Z"},{"user":"packer6@nikura.com","date":"2025-09-24T09:22:57.013Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:21:36.85Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:21:10.37Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:18:46.107Z"},{"user":"packer6@nikura.com","date":"2025-09-24T09:17:54.92Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:17:20.77Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:16:08.8Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:15:52.183Z"},{"user":"packer8@nikura.com","date":"2025-09-24T09:15:41.58Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:14:53.43Z"},{"user":"packer8@nikura.com","date":"2025-09-24T09:13:50.253Z"},{"user":"packer6@nikura.com","date":"2025-09-24T09:12:42.09Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:11:08.32Z"},{"user":"packer8@nikura.com","date":"2025-09-24T09:11:02.883Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:09:20.233Z"},{"user":"packer8@nikura.com","date":"2025-09-24T09:08:47.64Z"},{"user":"packer6@nikura.com","date":"2025-09-24T09:08:26.593Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:07:18.17Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:06:15.383Z"},{"user":"packer8@nikura.com","date":"2025-09-24T09:05:57.733Z"},{"user":"packer7@nikura.com","date":"2025-09-24T09:05:40.897Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:04:51.843Z"},{"user":"packer6@nikura.com","date":"2025-09-24T09:04:38.883Z"},{"user":"packer8@nikura.com","date":"2025-09-24T09:03:36.04Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:02:25.94Z"},{"user":"packer3@nikura.com","date":"2025-09-24T09:00:10.007Z"},{"user":"packer6@nikura.com","date":"2025-09-24T09:00:03.707Z"},{"user":"packer8@nikura.com","date":"2025-09-24T08:59:14.01Z"},{"user":"packer3@nikura.com","date":"2025-09-24T08:59:11.42Z"},{"user":"packer8@nikura.com","date":"2025-09-24T08:58:01.527Z"},{"user":"packer6@nikura.com","date":"2025-09-24T08:57:09.603Z"},{"user":"packer6@nikura.com","date":"2025-09-24T08:52:07.18Z"},{"user":"packer7@nikura.com","date":"2025-09-24T08:51:12.457Z"},{"user":"packer6@nikura.com","date":"2025-09-24T08:49:10.4Z"},{"user":"packer7@nikura.com","date":"2025-09-24T08:49:06.267Z"},{"user":"packer3@nikura.com","date":"2025-09-24T08:48:45.337Z"},{"user":"packer7@nikura.com","date":"2025-09-24T08:47:07.78Z"},{"user":"packer3@nikura.com","date":"2025-09-24T08:47:04.18Z"},{"user":"packer6@nikura.com","date":"2025-09-24T08:45:01.013Z"},{"user":"packer3@nikura.com","date":"2025-09-24T08:44:14.05Z"},{"user":"packer7@nikura.com","date":"2025-09-24T08:43:41.473Z"},{"user":"packer8@nikura.com","date":"2025-09-24T08:43:16.627Z"},{"user":"packer3@nikura.com","date":"2025-09-24T08:42:48.07Z"},{"user":"packer3@nikura.com","date":"2025-09-24T08:41:30.31Z"},{"user":"packer7@nikura.com","date":"2025-09-24T08:40:33.327Z"},{"user":"packer8@nikura.com","date":"2025-09-24T08:39:49.91Z"},{"user":"packer6@nikura.com","date":"2025-09-24T08:39:46.717Z"},{"user":"packer3@nikura.com","date":"2025-09-24T08:39:34.06Z"},{"user":"packer3@nikura.com","date":"2025-09-24T08:38:26.01Z"},{"user":"packer3@nikura.com","date":"2025-09-24T08:37:16.973Z"},{"user":"packer7@nikura.com","date":"2025-09-24T08:36:51.01Z"},{"user":"packer8@nikura.com","date":"2025-09-24T08:37:01.73Z"},{"user":"packer7@nikura.com","date":"2025-09-24T08:35:31.833Z"},{"user":"packer6@nikura.com","date":"2025-09-24T08:34:54.13Z"},{"user":"packer8@nikura.com","date":"2025-09-24T08:32:29.943Z"},{"user":"packer6@nikura.com","date":"2025-09-24T08:31:18.837Z"},{"user":"packer7@nikura.com","date":"2025-09-24T08:29:54.24Z"},{"user":"packer6@nikura.com","date":"2025-09-24T08:27:14.973Z"},{"user":"packer7@nikura.com","date":"2025-09-24T08:21:58.47Z"},{"user":"packer6@nikura.com","date":"2025-09-24T08:21:13.66Z"},{"user":"packer7@nikura.com","date":"2025-09-24T08:14:38.773Z"},{"user":"packer7@nikura.com","date":"2025-09-24T08:12:58.063Z"},{"user":"packer7@nikura.com","date":"2025-09-24T07:54:09.36Z"},{"user":"packer7@nikura.com","date":"2025-09-24T07:49:17.877Z"},{"user":"packer7@nikura.com","date":"2025-09-24T07:44:49.123Z"},{"user":"packer7@nikura.com","date":"2025-09-24T07:43:33.7Z"},{"user":"packer7@nikura.com","date":"2025-09-24T07:39:24.09Z"},{"user":"packer7@nikura.com","date":"2025-09-24T07:34:59.983Z"},{"user":"packer7@nikura.com","date":"2025-09-24T07:31:52.537Z"},{"user":"packer7@nikura.com","date":"2025-09-24T07:29:23.977Z"},{"user":"packer7@nikura.com","date":"2025-09-24T07:26:51.32Z"},{"user":"packer7@nikura.com","date":"2025-09-24T07:24:27.503Z"},{"user":"packer7@nikura.com","date":"2025-09-24T07:22:15.987Z"},{"user":"packer7@nikura.com","date":"2025-09-24T07:20:25.747Z"},{"user":"packer7@nikura.com","date":"2025-09-24T07:17:49.643Z"},{"user":"packer7@nikura.com","date":"2025-09-24T07:16:28.683Z"},{"user":"packer7@nikura.com","date":"2025-09-24T07:15:23.12Z"}]; // [{user, date}]
const HOUR_LABELS_ALL = ["Midnight-1am","1am-2am","2am-3am","3am-4am","4am-5am","5am-6am","6am-7am","7am-8am","8am-9am","9am-10am","10am-11am","11am-Noon","Noon-1pm","1pm-2pm","2pm-3pm","3pm-4pm","4pm-5pm","5pm-6pm","6pm-7pm","7pm-8pm","8pm-9pm","9pm-10pm","10pm-11pm","11pm-midnight"];

// DST-aware London hour
function toLondonHour(d){
  const date = (d instanceof Date) ? d : new Date(d);
  return Number(new Intl.DateTimeFormat('en-GB',{timeZone:'Europe/London',hour:'numeric',hour12:false}).format(date));
}
function esc(s=""){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function ymd(date){ const d=new Date(date); const z=n=>String(n).padStart(2,'0'); return d.getFullYear()+"-"+z(d.getMonth()+1)+"-"+z(d.getDate()); }

function buildAggregates(events){
  const byUser = {};
  for(const ev of events){
    const hour = toLondonHour(ev.date);
    const u = ev.user || "UNKNOWN";
    if(!byUser[u]) byUser[u] = { total:0, hours:Array(24).fill(0), times:[] };
    byUser[u].total++;
    byUser[u].hours[hour]++;
    byUser[u].times.push(new Date(ev.date));
  }
  const users = Object.keys(byUser).sort((a,b)=>byUser[b].total - byUser[a].total);
  const hourUsed = Array(24).fill(false);
  for(const u of users) byUser[u].hours.forEach((v,i)=>{ if(v>0) hourUsed[i]=true; });
  const keptHourIdx = hourUsed.map((used,i)=> used? i:-1).filter(i=>i>=0);
  const hourLabels = keptHourIdx.map(i=> HOUR_LABELS_ALL[i]);

  const compactRows = [];
  users.forEach(u=>{
    compactRows.push({ userLabel:u, total:byUser[u].total, buckets: keptHourIdx.map(i=>byUser[u].hours[i]) });
    compactRows.push({ userLabel:u+" Avg/min Order", total:"", buckets: keptHourIdx.map(i=>{
      const times = byUser[u].times.filter(t=> toLondonHour(t)===i).sort((a,b)=>a-b);
      if(times.length<=1) return 0;
      const mins=(times[times.length-1]-times[0])/60000;
      const avg=mins/(times.length-1);
      if(!isFinite(avg)||avg<=0) return 0;
      const m=Math.floor(avg), s=Math.round((avg-m)*60);
      return `${m}m ${s}s`;
    })});
  });
  return { byUser, users, keptHourIdx, hourLabels, compactRows };
}

function buildCompactTable(headers, rows){
  let html = '<table><thead><tr><th>User</th><th>Total Dispatched</th>';
  headers.forEach(h=> html += '<th>'+esc(h)+'</th>');
  html += '</tr></thead><tbody>';
  rows.forEach(r=>{
    const baseUser = String(r.userLabel).replace(' Avg/min Order','');
    html += '<tr data-user="'+esc(baseUser)+'"><td>'+esc(r.userLabel)+'</td><td>'+esc(r.total||'')+'</td>';
    r.buckets.forEach(v=> html += '<td>'+esc(v)+'</td>');
    html += '</tr>';
  });
  html += '</tbody></table>';
  return html;
}

function buildTotalsTable(users, byUser){
  let html = '<table style="width:40%;margin-top:10px"><thead><tr><th>User</th><th>Total</th></tr></thead><tbody>';
  users.forEach(u=> html += '<tr data-user="'+esc(u)+'"><td>'+esc(u)+'</td><td>'+byUser[u].total+'</td></tr>');
  html += '</tbody></table>';
  return html;
}

function buildGroupedBarSVG(rows, labels){
  const padding={top:30,right:20,bottom:70,left:50};
  const w=Math.max(700, labels.length*70), h=320;
  const innerW=w-padding.left-padding.right, innerH=h-padding.top-padding.bottom;
  const nGroups=labels.length, nSeries=rows.length;
  const maxVal=Math.max(1, ...rows.flatMap(r=> r.buckets.map(v=> (typeof v==='number'?v:0))));
  const groupWidth=innerW/nGroups, barGap=6, barWidth=Math.max(8,(groupWidth - barGap*(nSeries+1))/nSeries);
  const colors=["#5B8FF9","#5AD8A6","#5D7092","#F6BD16","#E8684A","#6DC8EC","#9270CA","#FF9D4D"];
  let svg = '<svg width="'+w+'" height="'+h+'" xmlns="http://www.w3.org/2000/svg"><g transform="translate('+padding.left+','+padding.top+')">';
  const ticks=[0,0.25,0.5,0.75,1].map(t=>Math.round(t*maxVal));
  for(const t of ticks){
    const y=innerH-(t/maxVal)*innerH;
    svg += '<line x1="0" y1="'+y+'" x2="'+innerW+'" y2="'+y+'" stroke="#eee"/>';
    svg += '<text x="-6" y="'+(y+4)+'" text-anchor="end" font-size="11">'+t+'</text>';
  }
  labels.forEach((lab,gi)=>{
    const x=gi*groupWidth+groupWidth/2;
    svg += '<text x="'+x+'" y="'+(innerH+18)+'" text-anchor="middle" font-size="11">'+esc(lab)+'</text>';
  });
  labels.forEach((_,gi)=>{
    const groupX=gi*groupWidth;
    rows.forEach((r,si)=>{
      const val=(typeof r.buckets[gi]==='number')?r.buckets[gi]:0;
      const barH=(val/maxVal)*innerH;
      const x=groupX+barGap+si*(barWidth+barGap);
      const y=innerH-barH;
      svg += '<rect data-series="'+si+'" x="'+x+'" y="'+y+'" width="'+barWidth+'" height="'+barH+'" fill="'+colors[si%colors.length]+'"/>';
    });
  });
  svg += '</g></svg>';
  return svg;
}

function applyUserFilter(){
  const toggles = document.querySelectorAll('.user-toggle');
  const selected = Array.from(toggles).filter(t=>t.checked).map(t=>t.dataset.user);
  document.querySelectorAll('table tbody tr').forEach(row=>{
    const u=row.getAttribute('data-user');
    row.style.display = selected.includes(u)? '': 'none';
  });
  document.querySelectorAll('svg g rect').forEach(rect=>{
    const idx=rect.dataset.series;
    if(idx!==undefined){
      const u=window.__currentUsers[Number(idx)];
      rect.style.display = selected.includes(u)? '': 'none';
    }
  });
}

function recalc(){
  const from = document.getElementById('fromDate').value;
  const to   = document.getElementById('toDate').value;
  const fromTs = from ? new Date(from+'T00:00:00Z').getTime() : -Infinity;
  const toTs   = to   ? new Date(to  +'T23:59:59.999Z').getTime() :  Infinity;

  const filtered = RAW_EVENTS.filter(ev=>{
    const ts = new Date(ev.date).getTime();
    return ts>=fromTs && ts<=toTs;
  });

  const {byUser, users, keptHourIdx, hourLabels, compactRows} = (function(){
    // Build aggregates from filtered
    const bu = {};
    for (const ev of filtered){
      const hour = toLondonHour(ev.date);
      const u = ev.user || "UNKNOWN";
      if(!bu[u]) bu[u] = { total:0, hours:Array(24).fill(0), times:[] };
      bu[u].total++; bu[u].hours[hour]++; bu[u].times.push(new Date(ev.date));
    }
    const us = Object.keys(bu).sort((a,b)=>bu[b].total - bu[a].total);
    const used = Array(24).fill(false);
    for(const u of us) bu[u].hours.forEach((v,i)=>{ if(v>0) used[i]=true; });
    const keep = used.map((x,i)=>x?i:-1).filter(i=>i>=0);
    const labels = keep.map(i=> HOUR_LABELS_ALL[i]);

    const rows=[];
    us.forEach(u=>{
      rows.push({ userLabel:u, total:bu[u].total, buckets: keep.map(i=>bu[u].hours[i]) });
      rows.push({ userLabel:u+" Avg/min Order", total:"", buckets: keep.map(i=>{
        const times = bu[u].times.filter(t=> toLondonHour(t)===i).sort((a,b)=>a-b);
        if(times.length<=1) return 0;
        const mins=(times[times.length-1]-times[0])/60000;
        const avg=mins/(times.length-1);
        if(!isFinite(avg)||avg<=0) return 0;
        const m=Math.floor(avg), s=Math.round((avg-m)*60);
        return m+'m '+s+'s';
      })});
    });
    // expose users for chart filter
    window.__currentUsers = us.slice();
    return { byUser: bu, users: us, keptHourIdx: keep, hourLabels: labels, compactRows: rows };
  })();

  document.getElementById('rangeInfo').textContent = 'Rows in range: '+filtered.length;
  document.getElementById('table-wrapper').innerHTML = buildCompactTable(hourLabels, compactRows);

  const orderRows = users.map(u=>({ user:u, buckets: keptHourIdx.map(i=> byUser[u].hours[i]) }));
  const avgRows   = users.map(u=>({ user:u, buckets: keptHourIdx.map(i=>{
    const times=(byUser[u].times||[]).filter(t=> toLondonHour(t)===i).sort((a,b)=>a-b);
    if(times.length<=1) return 0;
    const mins=(times[times.length-1]-times[0])/60000;
    return mins/(times.length-1);
  })}));
  document.getElementById('chart-orders').innerHTML = buildGroupedBarSVG(orderRows, hourLabels);
  document.getElementById('chart-avg').innerHTML    = buildGroupedBarSVG(avgRows, hourLabels);
  document.getElementById('totals-table').innerHTML = (function(){
    let html='<table style="width:40%;margin-top:10px"><thead><tr><th>User</th><th>Total</th></tr></thead><tbody>';
    users.forEach(u=> html+='<tr data-user="'+esc(u)+'"><td>'+esc(u)+'</td><td>'+byUser[u].total+'</td></tr>');
    html+='</tbody></table>'; return html;
  })();

  // Apply current user toggle state
  applyUserFilter();
}

(function init(){
  // default: last 10 days (inclusive)
  const now = new Date();
  const end = new Date(now.getTime());
  const start = new Date(now.getTime() - 9*24*60*60*1000);
  document.getElementById('fromDate').value = ymd(start);
  document.getElementById('toDate').value   = ymd(end);

  document.getElementById('applyBtn').addEventListener('click', recalc);
  document.querySelectorAll('.user-toggle').forEach(t=> t.addEventListener('change', applyUserFilter));

  recalc(); // initial draw
})();
</script>

</body>
</html>