
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Linnworks Packing Report</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;margin:20px;max-width:1200px;}
  h3{margin-top:28px;margin-bottom:12px;}
  .panels{display:flex;gap:16px;flex-wrap:wrap;}
  .filters{border:1px solid #ccc;padding:12px;background:#fafafa;border-radius:6px;min-width:260px}
  table{border-collapse:collapse;width:100%;margin-bottom:20px;table-layout:fixed;}
  th,td{border:1px solid #ddd;padding:6px 8px;font-size:13px;text-align:center;}
  thead th{background:#f8f8f8;font-weight:600;}
  tbody tr:nth-child(even) td{background:#fafafa;}
  svg{display:block;margin:10px auto 30px auto;}
  label{display:inline-block;margin:4px 0;}
</style>
</head>
<body>

<h1>Linnworks Packing Report</h1>

<div class="panels">
  <div class="filters">
    <strong>Processed Date Range</strong><br/>
    <label>From: <input type="date" id="fromDate" value="2025-09-19"></label><br/>
    <label>To: <input type="date" id="toDate" value="2025-09-28"></label><br/>
    <button id="applyBtn">Apply</button>
    <div id="rangeInfo" style="margin-top:6px;color:#555;font-size:12px"></div>
  </div>

  <div class="filters">
    <strong>Show Packers</strong><br/>
    <label><input type="checkbox" class="user-toggle" data-user="Confirming Shipments for FBA Orders" checked/> Confirming Shipments for FBA Orders</label><br/><label><input type="checkbox" class="user-toggle" data-user="EVENT DESPATCHER" checked/> EVENT DESPATCHER</label><br/>
  </div>
</div>

<h3>Events per Hour (Compact)</h3>
<div id="table-wrapper"></div>

<h3>Events per Hour (Chart)</h3>
<div id="chart-orders"></div>

<h3>Average Minutes per Event (Chart)</h3>
<div id="chart-avg"></div>

<h3>Totals</h3>
<div id="totals-table"></div>

<script>
const RAW_EVENTS = [{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:53.703Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:53.7Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:53.613Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:53.433Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-09-01T01:17:14.267Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-09-01T00:15:02.883Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-08-31T23:12:20.3Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-08-31T22:10:47.967Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-08-31T21:09:00.2Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-08-31T20:04:50.54Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-08-31T19:03:13.467Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-08-31T18:01:17.36Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-08-31T16:57:15.463Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-08-31T15:55:52.637Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-08-31T14:54:21.453Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-08-31T13:52:10.25Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-08-31T12:50:29.86Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-08-31T11:48:22.633Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-08-31T10:46:18.843Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-08-31T09:44:02.447Z"},{"user":"EVENT DESPATCHER","date":"2025-08-31T08:42:39.14Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-08-31T08:42:18.797Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:52.523Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:51.967Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:51.887Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:51.713Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:50.237Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:49.46Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:49Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:48.577Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:47.45Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:47.233Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:46.513Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:46.34Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:46.257Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:45.903Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:45.69Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:45.603Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:45.097Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:44.77Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:21:00.53Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:44.06Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:43.983Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:43.38Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:42.853Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:42.223Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:42.04Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:41.96Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:41.43Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:41.06Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:40.877Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:40.797Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:40.59Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:40.143Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:39.803Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:39.717Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:39.537Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:39.09Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:38.77Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:38.453Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:38.213Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:37.237Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:37.047Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:36.95Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:36.683Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:36.68Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:48.113Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:36.453Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:36.343Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:36.227Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:35.957Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:34.437Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:33.77Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:33.46Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:32.167Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:31.923Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:31.357Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:31.227Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:28.467Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:28.39Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:28.197Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:41.56Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:27.843Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:27.463Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:27.197Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:27.09Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:27Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:26.917Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:26.833Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:26.03Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:25.953Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:25.86Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:25.06Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:24.6Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:24.213Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:24.047Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:23.24Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:22.877Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:22.2Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:22.197Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:20.26Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:19.447Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:17.837Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:17.453Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:16.27Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:16.267Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:16.24Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:16.237Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:15.683Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:15.3Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:13.52Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:13.3Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:13.103Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:12.62Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:12.527Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:12.427Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:12.35Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:11.37Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:11.103Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:11.02Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:31.727Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:10.723Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:10.553Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:10.173Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:09.983Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:09.23Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:06.28Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:05.16Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:04.607Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:04.39Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:03.467Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:02.983Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:02.657Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:02.467Z"},{"user":"EVENT DESPATCHER","date":"2025-08-31T21:09:05.967Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-08-31T21:07:00.027Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:01.67Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:29:00.453Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:59.053Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:59.033Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:58.05Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:54.81Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:54.6Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:53.66Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:52.227Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:50.743Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:49.447Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:49.317Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:47.5Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:45.367Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:45.02Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:43.66Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:43.053Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:42.47Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:41.34Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:40.767Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:39.907Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:39.367Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:39.177Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:38.887Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T06:28:38.877Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:25:00.78Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-09-01T03:24:29.21Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:25:00.7Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:25:00.23Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:24:59.73Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:24:58.423Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:24:58.05Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:24:54.737Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-09-01T03:23:43.313Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:24:51.94Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:24:51.65Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:24:46.487Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:24:46.353Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:24:46.18Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:24:45.507Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:24:44.823Z"},{"user":"Confirming Shipments for FBA Orders","date":"2025-09-01T03:22:35.763Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:24:44.18Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:24:42.98Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:24:39.42Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:24:37.753Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:24:37.437Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:21:14.66Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:21:13.05Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:21:12.353Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:21:12.253Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:21:12.25Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:21:12.06Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:21:10.287Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:21:09.47Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:21:09.243Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:21:09.207Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:21:08Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:21:07.06Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:21:04.98Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:21:01.777Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:21:01.197Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:21:00.13Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:58.6Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:56.053Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:55.707Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:54.35Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:54.023Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:53.99Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:53.763Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:51.343Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:50.413Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:49.54Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:49.2Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:48.82Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:48.713Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:47.22Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:46.883Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:45.893Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:44.43Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:40.97Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:40.737Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:38.883Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:38.187Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:37.98Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:37.727Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:37.23Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:36.907Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:35.717Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:32.98Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:31.63Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:31.627Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:31.073Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:30.137Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:29.707Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:28.203Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:27.713Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:27.083Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:25.773Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:25.463Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:25.46Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:24.57Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:23.183Z"},{"user":"EVENT DESPATCHER","date":"2025-09-01T03:20:17.247Z"}];
const HOUR_LABELS_ALL = ["Midnight-1am","1am-2am","2am-3am","3am-4am","4am-5am","5am-6am","6am-7am","7am-8am","8am-9am","9am-10am","10am-11am","11am-Noon","Noon-1pm","1pm-2pm","2pm-3pm","3pm-4pm","4pm-5pm","5pm-6pm","6pm-7pm","7pm-8pm","8pm-9pm","9pm-10pm","10pm-11pm","11pm-midnight"];
const ALL_USERS = ["Confirming Shipments for FBA Orders","EVENT DESPATCHER"];

function toLondonHour(dateish){
  const d = (dateish instanceof Date) ? dateish : new Date(dateish);
  return Number(new Intl.DateTimeFormat('en-GB',{ timeZone:'Europe/London', hour:'numeric', hour12:false }).format(d));
}
function esc(s=""){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function ymd(dateish){ const d=new Date(dateish); const z=n=>String(n).padStart(2,'0'); return d.getFullYear()+"-"+z(d.getMonth()+1)+"-"+z(d.getDate()); }

function buildGroupedBarSVG(rows, labels){
  const padding={top:30,right:20,bottom:70,left:50};
  const w=Math.max(700, labels.length*70), h=320;
  const innerW=w-padding.left-padding.right, innerH=h-padding.top-padding.bottom;
  const maxVal=Math.max(1, ...rows.flatMap(r=> r.buckets.map(v=> (typeof v==='number'?v:0))));
  const nGroups=labels.length, nSeries=rows.length;
  const groupWidth=innerW/nGroups, barGap=6, barWidth=Math.max(8,(groupWidth - barGap*(nSeries+1))/nSeries);
  const colors=["#5B8FF9","#5AD8A6","#5D7092","#F6BD16","#E8684A","#6DC8EC","#9270CA","#FF9D4D"];
  let svg = '<svg width="'+w+'" height="'+h+'" xmlns="http://www.w3.org/2000/svg"><g transform="translate('+padding.left+','+padding.top+')">';
  const ticks=[0,0.25,0.5,0.75,1].map(t=>Math.round(t*maxVal));
  for(const t of ticks){
    const y=innerH-(t/maxVal)*innerH;
    svg += '<line x1="0" y1="'+y+'" x2="'+innerW+'" y2="'+y+'" stroke="#eee"/>';
    svg += '<text x="-6" y="'+(y+4)+'" text-anchor="end" font-size="11">'+t+'</text>';
  }
  labels.forEach((lab,gi)=>{
    const x=gi*groupWidth+groupWidth/2;
    svg += '<text x="'+x+'" y="'+(innerH+18)+'" text-anchor="middle" font-size="11">'+esc(lab)+'</text>';
  });
  labels.forEach((_,gi)=>{
    const groupX=gi*groupWidth;
    rows.forEach((r,si)=>{
      const val=(typeof r.buckets[gi]==='number')?r.buckets[gi]:0;
      const barH=(val/maxVal)*innerH;
      const x=groupX+barGap+si*(barWidth+barGap);
      const y=innerH-barH;
      svg += '<rect data-series="'+si+'" x="'+x+'" y="'+y+'" width="'+barWidth+'" height="'+barH+'" fill="'+colors[si%colors.length]+'"/>';
    });
  });
  svg += '</g></svg>';
  return svg;
}

function buildCompactTable(headers, rows){
  let html = '<table><thead><tr><th>User</th><th>Total</th>';
  headers.forEach(h=> html += '<th>'+esc(h)+'</th>');
  html += '</tr></thead><tbody>';
  rows.forEach(r=>{
    const baseUser = String(r.userLabel).replace(' Avg/min Order','');
    html += '<tr data-user="'+esc(baseUser)+'"><td>'+esc(r.userLabel)+'</td><td>'+esc(r.total||'')+'</td>';
    r.buckets.forEach(v=> html += '<td>'+esc(v)+'</td>');
    html += '</tr>';
  });
  html += '</tbody></table>';
  return html;
}

function buildTotalsTable(users, byUser){
  let html = '<table style="width:40%;margin-top:10px"><thead><tr><th>User</th><th>Total</th></tr></thead><tbody>';
  users.forEach(u=> html += '<tr data-user="'+esc(u)+'"><td>'+esc(u)+'</td><td>'+byUser[u].total+'</td></tr>');
  html += '</tbody></table>';
  return html;
}

function aggregate(events){
  const byUser = {};
  for(const ev of events){
    const hour = toLondonHour(ev.date);
    const u = ev.user || "UNKNOWN";
    if(!byUser[u]) byUser[u] = { total:0, hours:Array(24).fill(0), times:[] };
    byUser[u].total++; byUser[u].hours[hour]++; byUser[u].times.push(new Date(ev.date));
  }
  const users = Object.keys(byUser).sort((a,b)=>byUser[b].total - byUser[a].total);
  const used = Array(24).fill(false);
  for(const u of users) byUser[u].hours.forEach((v,i)=>{ if(v>0) used[i]=true; });
  const keep = used.map((x,i)=>x?i:-1).filter(i=>i>=0);
  const labels = keep.map(i=> HOUR_LABELS_ALL[i]);
  const compactRows = [];
  users.forEach(u=>{
    compactRows.push({ userLabel:u, total:byUser[u].total, buckets: keep.map(i=>byUser[u].hours[i]) });
    compactRows.push({ userLabel:u+" Avg/min Order", total:"", buckets: keep.map(i=>{
      const times = byUser[u].times.filter(t=> toLondonHour(t)===i).sort((a,b)=>a-b);
      if(times.length<=1) return 0;
      const mins=(times[times.length-1]-times[0])/60000;
      const avg=mins/(times.length-1);
      if(!isFinite(avg)||avg<=0) return 0;
      const m=Math.floor(avg), s=Math.round((avg-m)*60);
      return m+'m '+s+'s';
    })});
  });
  return { byUser, users, keep, labels, compactRows };
}

function applyUserFilter(){
  const toggles = document.querySelectorAll('.user-toggle');
  const selected = Array.from(toggles).filter(t=>t.checked).map(t=>t.dataset.user);
  document.querySelectorAll('table tbody tr').forEach(row=>{
    const u=row.getAttribute('data-user');
    row.style.display = selected.includes(u)? '': 'none';
  });
  document.querySelectorAll('svg g rect').forEach(rect=>{
    const idx=rect.dataset.series;
    if(idx!==undefined){
      const u=window.__currentUsers[Number(idx)];
      rect.style.display = selected.includes(u)? '': 'none';
    }
  });
}

function recalc(){
  const from = document.getElementById('fromDate').value;
  const to   = document.getElementById('toDate').value;
  const fromTs = from ? new Date(from+'T00:00:00Z').getTime() : -Infinity;
  const toTs   = to   ? new Date(to  +'T23:59:59.999Z').getTime() :  Infinity;

  const filtered = RAW_EVENTS.filter(ev=>{
    const ts = new Date(ev.date).getTime();
    return ts>=fromTs && ts<=toTs;
  });

  const {byUser, users, keep, labels, compactRows} = aggregate(filtered);

  document.getElementById('rangeInfo').textContent = 'Rows in range: '+filtered.length;
  document.getElementById('table-wrapper').innerHTML = buildCompactTable(labels, compactRows);

  const orderRows = users.map(u=>({ user:u, buckets: keep.map(i=> byUser[u].hours[i]) }));
  const avgRows   = users.map(u=>({ user:u, buckets: keep.map(i=>{
    const times=(byUser[u].times||[]).filter(t=> toLondonHour(t)===i).sort((a,b)=>a-b);
    if(times.length<=1) return 0;
    const mins=(times[times.length-1]-times[0])/60000;
    return mins/(times.length-1);
  })}));

  document.getElementById('chart-orders').innerHTML = buildGroupedBarSVG(orderRows, labels);
  document.getElementById('chart-avg').innerHTML    = buildGroupedBarSVG(avgRows, labels);
  document.getElementById('totals-table').innerHTML = buildTotalsTable(users, byUser);

  window.__currentUsers = users.slice();
  applyUserFilter();
}

(function init(){
  document.getElementById('applyBtn').addEventListener('click', recalc);
  document.querySelectorAll('.user-toggle').forEach(t=> t.addEventListener('change', applyUserFilter));
  recalc();
})();
</script>

</body>
</html>